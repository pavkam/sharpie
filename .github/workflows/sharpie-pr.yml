name: ðŸ§¨ Verify pull request

on:
  pull_request:

permissions:
  statuses: write
  checks: write
  contents: read
  issues: read
  pull-requests: write

jobs:
  test-ubuntu:
    name: ðŸ’ Test on Ubuntu
    runs-on: ubuntu-latest
    steps:
      - name: â˜ï¸ Checkout repository
        uses: actions/checkout@v4

      - name: â¯ï¸ Build and Test
        uses: ./.github/actions/build-and-test

  test-windows:
    name: ðŸ’ Test on Windows
    runs-on: windows-latest
    steps:
      - name: â˜ï¸ Checkout repository
        uses: actions/checkout@v4

      - name: â¯ï¸ Build and Test
        uses: ./.github/actions/build-and-test

  test-macos:
    name: ðŸ’ Test on macOS
    runs-on: macos-latest
    steps:
      - name: â˜ï¸ Checkout repository
        uses: actions/checkout@v4

      - name: â¯ï¸ Build and Test
        uses: ./.github/actions/build-and-test

  summary:
    name: âœ”ï¸Ž Generate summary
    needs: [test-ubuntu, test-windows, test-macos]
    runs-on: ubuntu-latest
    if: ${{ always() }}

    steps:
      - name: â˜ï¸ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ“¥ Download all artifacts
        uses: actions/download-artifact@v4

      - name: ðŸ“ Create summary
        run: |
          # Evaluate individual platform statuses
          if [[ "${{ needs.test-ubuntu.result }}" == "success" ]]; then
            UBUNTU_ICON="âœ…"
            UBUNTU_TEXT="Success"
          else
            UBUNTU_ICON="âŒ"
            UBUNTU_TEXT="Failed"
          fi

          if [[ "${{ needs.test-windows.result }}" == "success" ]]; then
            WINDOWS_ICON="âœ…"
            WINDOWS_TEXT="Success"
          else
            WINDOWS_ICON="âŒ"
            WINDOWS_TEXT="Failed"
          fi

          if [[ "${{ needs.test-macos.result }}" == "success" ]]; then
            MACOS_ICON="âœ…"
            MACOS_TEXT="Success"
          else
            MACOS_ICON="âŒ"
            MACOS_TEXT="Failed"
          fi

          # Count successful platforms
          SUCCESS_COUNT=0
          if [[ "${{ needs.test-ubuntu.result }}" == "success" ]]; then SUCCESS_COUNT=$((SUCCESS_COUNT + 1)); fi
          if [[ "${{ needs.test-windows.result }}" == "success" ]]; then SUCCESS_COUNT=$((SUCCESS_COUNT + 1)); fi
          if [[ "${{ needs.test-macos.result }}" == "success" ]]; then SUCCESS_COUNT=$((SUCCESS_COUNT + 1)); fi

          # Determine overall status
          if [[ $SUCCESS_COUNT -eq 3 ]]; then
            OVERALL_ICON="âœ…"
            OVERALL_TEXT="All platforms passed"
            DETAILS_TEXT="ðŸ“Š Check coverage reports in the artifacts section"
          elif [[ $SUCCESS_COUNT -gt 0 ]]; then
            OVERALL_ICON="âš ï¸"
            OVERALL_TEXT="$SUCCESS_COUNT of 3 platforms passed"
            DETAILS_TEXT="ðŸ” Check the job logs for failed platforms"
          else
            OVERALL_ICON="âŒ"
            OVERALL_TEXT="All platforms failed"
            DETAILS_TEXT="ðŸ” Check the job logs for detailed error information"
          fi

          echo "## ðŸ§¨ CI Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Ubuntu | $UBUNTU_ICON $UBUNTU_TEXT |" >> $GITHUB_STEP_SUMMARY
          echo "| Windows | $WINDOWS_ICON $WINDOWS_TEXT |" >> $GITHUB_STEP_SUMMARY
          echo "| macOS | $MACOS_ICON $MACOS_TEXT |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“Š Test Results" >> $GITHUB_STEP_SUMMARY
          echo "$OVERALL_ICON $OVERALL_TEXT" >> $GITHUB_STEP_SUMMARY
          echo "$DETAILS_TEXT" >> $GITHUB_STEP_SUMMARY
